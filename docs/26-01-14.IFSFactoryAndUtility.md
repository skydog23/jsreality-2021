### Goal

Reduce duplication and avoid **circular ES-module imports** between:

- `src/core/geometry/IndexedFaceSetFactory.js`
- `src/core/geometry/IndexedFaceSetUtility.js`

while keeping the API close to the Java originals and using the same “overload cleanup” style used in `IndexedLineSetUtility`.

---

### Current situation

`IndexedFaceSetUtility.js` currently **imports** `IndexedFaceSetFactory`:

- `import { IndexedFaceSetFactory } from './IndexedFaceSetFactory.js';`

This import exists because `IndexedFaceSetUtility` contains several methods that **instantiate** a factory and/or **return** a factory as part of their public API.

In ES modules, having `Utility -> Factory` and `Factory -> Utility` is a **real circular dependency** (not just a conceptual one): module evaluation order and initialization timing can become fragile.

---

### Classification of methods in `IndexedFaceSetUtility`

#### Should remain in `IndexedFaceSetUtility` (factory-independent)

These are “process/edit/extract” methods that operate on `IndexedFaceSet`, arrays, `DataList`, or scene-graph traversal:

- **Edges**
  - `calculateAndSetEdgesFromFaces(ifs)`
  - `edgesFromFaces(facesData)`
- **Extraction**
  - `extractFace(ifs, which)`
  - `extractVerticesForFace(ifs, which)`
- **Normals**
  - `calculateAndSetFaceNormals(ifs)`
  - `calculateAndSetFaceNormalsWithMetric(ifs, metric)`
  - `calculateAndSetVertexNormals(ifs)`
  - `calculateAndSetNormals(ifs)`
  - `calculateFaceNormals(ifs)`
  - `calculateFaceNormalsWithMetric(ifs, metric)`
  - `calculateFaceNormalsFromArrays(indices, verts, metric)`
  - `calculateVertexNormals(ifs)`
  - `calculateVertexNormalsWithMetric(ifs, metric)`
  - `calculateVertexNormalsFromArrays(indices, vertsAs2D, fn, metric)`
  - `calculateFaceNormalsForSceneGraph(c)`
  - `calculateVertexNormalsForSceneGraph(c)`
- **Triangulation**
  - `simpleTriangulate(ifs)` (in-place)
  - `triangulate(fs)` (returns new IFS without using a factory)
- **Internal helpers**
  - `#getVectorLength(...)`, `#getVectorLengthFromPointSet(...)`, `#rotationIndex(...)`, etc.

#### Should move out of `IndexedFaceSetUtility` (factory-dependent constructors/producers)

These methods directly create a factory (or return one):

- **Polygon construction**
  - `constructPolygon(points)`
  - `constructPolygonWithFactory(ifsf, points)`
  - `constructPolygonWithMetric(ifsf, points, sig)`
  - `constructPolygonFactory(ifsf, points, sig)`  (directly does `new IndexedFaceSetFactory()`)
- **Geometry producers implemented via a factory**
  - `binaryRefine(ifs)`  (creates an output `IndexedFaceSetFactory`)
  - `implode(ifs, factor)` (creates an output `IndexedFaceSetFactory`)

These are the *only* reason `IndexedFaceSetUtility` needs to import `IndexedFaceSetFactory`.

---

### Proposed direction (no new “Algorithms” module)

#### 1) Make `IndexedFaceSetUtility` not depend on `IndexedFaceSetFactory`

- Move the factory-dependent methods above into `IndexedFaceSetFactory` as **static methods appended at the end** of the file.
- They will be mostly **wrappers**:
  - compute arrays (if needed),
  - create/configure an `IndexedFaceSetFactory`,
  - and when possible call into `IndexedFaceSetUtility` for the “pure algorithmic” parts (normals, edges-from-faces).

After this:

- `IndexedFaceSetUtility.js` no longer imports `IndexedFaceSetFactory`.
- The dependency direction becomes one-way: `IndexedFaceSetFactory -> IndexedFaceSetUtility` (safe).

#### 2) Keep “algorithmic” logic in the utility

The duplication currently observed in the factory (e.g. `_generateFaceNormals` vs `calculateFaceNormalsFromArrays`) should be resolved by the factory delegating to the utility.

This keeps the factory’s responsibilities as:

- **state + dirty flags + orchestration**, plus
- writing computed `DataList` results back into the geometry.

And keeps the utility as:

- **pure computations / edits** on existing geometries and arrays.

---

### Overloading cleanup opportunities (like `IndexedLineSetUtility`)

The biggest win is in the **polygon construction** family.

Instead of four separate names:

- `constructPolygon`
- `constructPolygonWithFactory`
- `constructPolygonWithMetric`
- `constructPolygonFactory`

use one canonical name with runtime dispatch:

- `IndexedFaceSetFactory.constructPolygon(...args)`

Suggested overload set (runtime-checked):

- `(points)`
- `(points, metric)`
- `(ifsf, points)`
- `(ifsf, points, metric)`

Then keep the old names as **deprecated wrappers** (optional), mirroring the style already used in `IndexedLineSetUtility`.

For normals, the current “stack”:

- `calculateFaceNormals(ifs)` → `calculateFaceNormalsWithMetric(ifs, metric)` → `calculateFaceNormalsFromArrays(...)`

is already readable and doesn’t strictly need dispatch unification.

---

### Minor cleanup notes

- `IndexedFaceSetUtility.constructPolygonFactory(...)` currently does `console.log(...)`. If this stays (even temporarily), it should likely be behind the existing logging system (or removed) for consistency.

---

### Expected end state

- `IndexedFaceSetUtility.js` contains only **factory-independent** utilities.
- `IndexedFaceSetFactory.js` contains:
  - instance factory behavior (current),
  - plus a small static section at end with factory-building wrappers:
    - `constructPolygon(...)` (overload-dispatched)
    - `binaryRefine(...)` (wrapper)
    - `implode(...)` (wrapper)
- The factory delegates computations to `IndexedFaceSetUtility` to avoid duplicated implementations.

